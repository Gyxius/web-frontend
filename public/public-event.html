<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Event ‚Äî Public View</title>
  <style>
    body { font-family: Inter, Roboto, Arial, sans-serif; background:#f7f7f5; color:#111; padding:20px; }
    .card { background:white; border-radius:12px; padding:20px; max-width:800px; margin:20px auto; box-shadow:0 6px 24px rgba(0,0,0,0.08);} 
    .title { font-size:22px; font-weight:700; margin-bottom:8px; }
    .meta { color:#666; margin-bottom:12px; }
    .section { margin-top:16px; }
    .avatar { width:56px; height:56px; border-radius:12px; display:inline-block; vertical-align:middle; margin-right:12px; }
    .attendee { display:flex; align-items:center; gap:12px; padding:8px 0; border-bottom:1px solid #f0f0f0 }
    .btn { display:inline-block; padding:8px 12px; border-radius:8px; background:#58CC02; color:white; text-decoration:none; font-weight:600; }
    .copy { margin-left:8px; font-size:13px; color:#666 }
  </style>
</head>
<body>
  <div class="card">
    <div id="content">
      <div id="eventView">
        <div class="title">Loading...</div>
        <div class="meta" id="meta"></div>
        <div id="desc"></div>

        <div class="section" id="languagesSection" style="display:none">
          <strong>üó£Ô∏è Languages</strong>
          <div id="languages" style="margin-top:8px"></div>
        </div>

        <div class="section" id="basedOn" style="display:none">
          <strong>‚ú® Based on Main Event</strong>
          <div id="basedContent" style="margin-top:8px"></div>
        </div>

        <div class="section">
          <strong>üë§ Hosted by</strong>
          <div id="host" style="margin-top:8px"></div>
        </div>

        <div class="section">
          <strong>üßÉ Attendees</strong>
          <div id="attendees"></div>
        </div>

        <div class="section">
          <strong>üí¨ Group Chat</strong>
          <div id="chat" style="margin-top:8px"></div>
        </div>

        <div class="section">
          <a id="appLink" class="btn" href="#">Open in App</a>
          <button id="copyBtn" class="btn" style="background:#3B82F6;margin-left:8px">Copy link</button>
          <span class="copy" id="copied"></span>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const API_URL = 'https://fast-api-backend-qlyb.onrender.com';
  const params = new URLSearchParams(window.location.search);
  const id = params.get('event') || params.get('id');
  const titleEl = document.querySelector('.title');
  const metaEl = document.getElementById('meta');
  const descEl = document.getElementById('desc');
  const attendeesEl = document.getElementById('attendees');
  const appLink = document.getElementById('appLink');
  const copied = document.getElementById('copied');

  if (!id) {
    titleEl.textContent = 'No event specified';
    metaEl.textContent = 'Open link like ?event=123';
    return;
  }

  function avatarForLocal(local) {
    if (!local) return null;
    if (local.avatar && local.avatar.provider === 'dicebear') return `https://api.dicebear.com/6.x/${local.avatar.style}/svg?seed=${encodeURIComponent(local.avatar.seed)}`;
    const emoji = local.emoji || 'üôÇ';
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><rect width='100%' height='100%' fill='%23EEE'/><text x='50%' y='50%' font-size='28' dominant-baseline='middle' text-anchor='middle'>${emoji}</text></svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  async function load() {
    try {
      const res = await fetch(`${API_URL}/api/events/${encodeURIComponent(id)}`);
      if (!res.ok) throw new Error('Not found');
      const ev = await res.json();

      titleEl.textContent = ev.name || 'Event';
      metaEl.textContent = `${ev.date || ''} ${ev.time || ''} ‚Ä¢ ${ev.venue || ev.location || ''}`;
      descEl.innerHTML = `<p>${ev.description || ''}</p>`;

      // languages
      const langEl = document.getElementById('languages');
      if (ev.languages && ev.languages.length > 0) {
        document.getElementById('languagesSection').style.display = 'block';
        langEl.innerHTML = ev.languages.map(l => `<span style="display:inline-block;background:#EFEFEF;padding:6px 10px;border-radius:999px;margin-right:8px;font-weight:700">${l}</span>`).join('');
      }

      // based on
      if (ev.templateEventName) {
        document.getElementById('basedOn').style.display = 'block';
        document.getElementById('basedContent').innerHTML = `<div style="font-weight:700">${ev.templateEventName}</div><div style="color:#666;font-size:13px">${ev.templateEventVenue || ''} ¬∑ ${ev.templateEventDate || ''}</div>`;
      }

      // host
      const hostEl = document.getElementById('host');
      const hostName = ev.host || (ev.host && ev.host.name) || ev.created_by || ev.createdBy || '';
      let hostLocal = null;
      try { hostLocal = localStorage.getItem('userProfile_' + hostName); hostLocal = hostLocal ? JSON.parse(hostLocal) : null; } catch(e) {}
      const hostRow = document.createElement('div');
      hostRow.className = 'attendee';
      const hostAvatar = document.createElement('img');
      hostAvatar.className = 'avatar';
      hostAvatar.src = avatarForLocal(hostLocal) || '';
      const hostInfo = document.createElement('div');
      hostInfo.innerHTML = `<strong>${(hostLocal && hostLocal.name) || hostName}</strong><div style='color:#666;font-size:13px'>${(hostLocal && (hostLocal.homeCountries && hostLocal.homeCountries.join(' '))) || (hostLocal && hostLocal.country) || ''}</div>`;
      hostRow.appendChild(hostAvatar);
      hostRow.appendChild(hostInfo);
      hostEl.appendChild(hostRow);

      // attendees
      attendeesEl.innerHTML = '';
      const participants = ev.participants || [];
      if (participants.length === 0) {
        attendeesEl.textContent = 'No attendees yet';
      } else {
        participants.forEach(p => {
          const row = document.createElement('div');
          row.className = 'attendee';
          const avatar = document.createElement('img');
          avatar.className = 'avatar';
          let local = null;
          try { local = localStorage.getItem('userProfile_' + p); local = local ? JSON.parse(local) : null; } catch(e) {}
          avatar.src = avatarForLocal(local) || '';
          const name = document.createElement('div');
          const levels = (local && local.languageLevels) ? Object.entries(local.languageLevels).map(([k,v]) => `${k}: ${v}`).join(' ¬∑ ') : '';
          name.innerHTML = `<strong>${(local && local.name) || p}</strong><div style='color:#666;font-size:13px'>${levels}</div>`;
          row.appendChild(avatar);
          row.appendChild(name);
          attendeesEl.appendChild(row);
        });
      }

      // chat (read-only)
      const chatEl = document.getElementById('chat');
      chatEl.innerHTML = '';
      try {
        const chatRes = await fetch(`${API_URL}/api/chat/${encodeURIComponent(id)}`);
        if (chatRes.ok) {
          const chatMsgs = await chatRes.json();
          if (Array.isArray(chatMsgs) && chatMsgs.length > 0) {
            chatMsgs.forEach(m => {
              const msgRow = document.createElement('div');
              msgRow.style.padding = '8px 10px';
              msgRow.style.borderBottom = '1px solid #F2F2F2';
              msgRow.innerHTML = `<div style='font-weight:700;margin-bottom:4px'>${m.username}</div><div style='color:#111'>${m.message}</div>`;
              chatEl.appendChild(msgRow);
            });
          } else {
            chatEl.textContent = 'No messages yet';
          }
        } else {
          chatEl.textContent = 'No messages yet';
        }
      } catch (e) {
        chatEl.textContent = 'No messages yet';
      }

      // share link and open in app
      const shareUrl = window.location.href;
      appLink.href = `/?event=${encodeURIComponent(id)}`;
      appLink.textContent = 'Open in App';
      document.getElementById('copyBtn').onclick = async () => {
        try { await navigator.clipboard.writeText(shareUrl); copied.textContent = 'Copied to clipboard'; setTimeout(() => copied.textContent = '', 2000); } catch { copied.textContent = 'Could not copy'; setTimeout(() => copied.textContent = '', 2000); }
      };

    } catch (e) {
      titleEl.textContent = 'Event not found';
      metaEl.textContent = '';
      descEl.textContent = '';
      attendeesEl.textContent = '';
    }
  }

  load();
})();
</script>
</body>
</html>